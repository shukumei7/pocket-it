<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket IT — Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0f1923;
            color: #c7d5e0;
            min-height: 100vh;
        }

        /* Nav */
        nav {
            background: #1b2838;
            border-bottom: 1px solid #2a475e;
            padding: 0 24px;
            display: flex;
            align-items: center;
            height: 56px;
        }
        nav .logo {
            font-size: 18px;
            font-weight: 700;
            color: #66c0f4;
            margin-right: 32px;
        }
        nav a {
            color: #8f98a0;
            text-decoration: none;
            padding: 16px 16px;
            font-size: 14px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        nav a:hover, nav a.active {
            color: #c7d5e0;
            border-bottom-color: #66c0f4;
        }
        nav .spacer { flex: 1; }
        nav .status-badge {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            background: #1b5e20;
            color: #a5d6a7;
        }

        /* Layout */
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }

        /* Stats cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: #1b2838;
            border: 1px solid #2a475e;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: border-color 0.2s, transform 0.1s;
        }
        .stat-card:hover {
            border-color: #66c0f4;
            transform: translateY(-2px);
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #66c0f4;
        }
        .stat-card .label {
            font-size: 13px;
            color: #8f98a0;
            margin-top: 4px;
        }

        /* Device grid */
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #c7d5e0;
        }
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        .device-card {
            background: #1b2838;
            border: 1px solid #2a475e;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .device-card:hover { border-color: #66c0f4; }
        .device-card .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .device-card .hostname {
            font-weight: 600;
            font-size: 15px;
        }
        .device-card .device-id {
            font-size: 11px;
            color: #8f98a0;
            font-family: monospace;
        }
        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.online { background: #66bb6a; }
        .status-dot.offline { background: #ef5350; }
        .device-card .last-seen {
            font-size: 12px;
            color: #8f98a0;
            margin-top: 8px;
        }
        .health-bar {
            height: 4px;
            background: #2a475e;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }
        .health-bar .fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }
        .health-bar .fill.good { background: #66bb6a; }
        .health-bar .fill.warning { background: #ffa726; }
        .health-bar .fill.critical { background: #ef5350; }
        .health-bar .fill.unknown { background: #8f98a0; }

        /* Ticket list */
        .ticket-list { list-style: none; }
        .ticket-item {
            background: #1b2838;
            border: 1px solid #2a475e;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .ticket-item .priority {
            width: 4px;
            height: 40px;
            border-radius: 2px;
        }
        .priority.low { background: #66bb6a; }
        .priority.medium { background: #ffa726; }
        .priority.high { background: #ef5350; }
        .priority.critical { background: #d50000; }
        .ticket-item .ticket-info { flex: 1; }
        .ticket-item .ticket-title { font-weight: 600; }
        .ticket-item .ticket-meta { font-size: 12px; color: #8f98a0; margin-top: 4px; }
        .ticket-status {
            font-size: 12px;
            padding: 3px 10px;
            border-radius: 10px;
        }
        .ticket-status.open { background: #1b3a5c; color: #66c0f4; }
        .ticket-status.in_progress { background: #4a3f00; color: #ffd54f; }
        .ticket-status.resolved { background: #1b5e20; color: #a5d6a7; }

        /* Device detail panel */
        .detail-panel {
            display: none;
            background: #1b2838;
            border: 1px solid #2a475e;
            border-radius: 8px;
            padding: 24px;
            margin-top: 16px;
        }
        .detail-panel.active { display: block; }
        .detail-panel .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .detail-panel .close-btn {
            background: none;
            border: 1px solid #2a475e;
            color: #8f98a0;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Chat in dashboard */
        .chat-area {
            background: #0f1923;
            border: 1px solid #2a475e;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            padding: 12px;
            margin-bottom: 12px;
        }
        .chat-area .msg {
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.4;
        }
        .chat-area .msg .sender-tag {
            font-weight: 600;
            margin-right: 6px;
        }
        .chat-area .msg .sender-tag.user { color: #66c0f4; }
        .chat-area .msg .sender-tag.ai { color: #ab47bc; }
        .chat-area .msg .sender-tag.it_tech { color: #66bb6a; }
        .chat-input-row {
            display: flex;
            gap: 8px;
        }
        .chat-input-row input {
            flex: 1;
            background: #0f1923;
            border: 1px solid #2a475e;
            color: #c7d5e0;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
        }
        .chat-input-row button {
            background: #66c0f4;
            color: #0f1923;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Diag buttons */
        .diag-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .diag-btn {
            background: #2a475e;
            color: #c7d5e0;
            border: none;
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .diag-btn:hover { background: #3d6080; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 48px;
            color: #8f98a0;
        }

        /* Pages */
        .page { display: none; }
        .page.active { display: block; }

        /* Alerts */
        .alert-list { list-style: none; }
        .alert-item {
            background: #1b2838;
            border: 1px solid #2a475e;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .alert-item .severity-indicator {
            width: 4px;
            height: 40px;
            border-radius: 2px;
            flex-shrink: 0;
        }
        .severity-indicator.critical { background: #d50000; }
        .severity-indicator.warning { background: #ffa726; }
        .alert-item .alert-info { flex: 1; }
        .alert-item .alert-title { font-weight: 600; font-size: 14px; }
        .alert-item .alert-meta { font-size: 12px; color: #8f98a0; margin-top: 4px; }
        .alert-item .alert-actions { display: flex; gap: 6px; }
        .alert-item .alert-actions button {
            background: #2a475e;
            color: #c7d5e0;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .alert-item .alert-actions button:hover { background: #3d6080; }
        .alert-item .alert-actions button.resolve-btn { background: #1b5e20; color: #a5d6a7; }
        .alert-item .alert-actions button.resolve-btn:hover { background: #2e7d32; }

        .alert-section {
            background: #1b2838;
            border: 1px solid #2a475e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .alert-section h3 { font-size: 15px; margin-bottom: 12px; color: #c7d5e0; }

        .threshold-table, .channel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .threshold-table th, .channel-table th {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #2a475e;
            color: #8f98a0;
            font-weight: 500;
        }
        .threshold-table td, .channel-table td {
            padding: 8px;
            border-bottom: 1px solid #1a2535;
        }
        .toggle-btn {
            background: none;
            border: 1px solid #2a475e;
            color: #8f98a0;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .toggle-btn.active { border-color: #66bb6a; color: #66bb6a; }
        .toggle-btn:hover { border-color: #66c0f4; color: #66c0f4; }

        .alert-filter-row {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .alert-filter-btn {
            background: #1b2838;
            border: 1px solid #2a475e;
            color: #8f98a0;
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .alert-filter-btn.active { background: #2a475e; color: #c7d5e0; border-color: #66c0f4; }

        /* File browser */
        .file-browser {
            background: #0f1923;
            border: 1px solid #2a475e;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }
        .file-breadcrumb {
            font-size: 12px;
            color: #8f98a0;
            margin-bottom: 8px;
            font-family: monospace;
        }
        .file-breadcrumb span { cursor: pointer; color: #66c0f4; }
        .file-breadcrumb span:hover { text-decoration: underline; }
        .file-list { list-style: none; max-height: 300px; overflow-y: auto; }
        .file-list li {
            padding: 6px 8px;
            font-size: 13px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .file-list li:hover { background: #1b2838; }
        .file-list .file-icon { width: 16px; text-align: center; }
        .file-list .file-name { flex: 1; }
        .file-list .file-size { font-size: 11px; color: #8f98a0; }
        .file-viewer {
            background: #0a0f14;
            border: 1px solid #2a475e;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
            max-height: 400px;
            overflow: auto;
        }
        .file-viewer pre {
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            margin: 0;
            color: #a8b4c0;
        }
        .file-viewer .file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            color: #8f98a0;
        }

        /* Script execution */
        .script-panel { margin-top: 12px; }
        .script-select {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .script-select select, .script-select button {
            background: #0f1923;
            border: 1px solid #2a475e;
            color: #c7d5e0;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
        }
        .script-select select { flex: 1; }
        .script-select button { cursor: pointer; }
        .script-select button:hover { background: #1b2838; }
        .script-textarea {
            width: 100%;
            background: #0a0f14;
            border: 1px solid #2a475e;
            color: #a8b4c0;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            min-height: 80px;
            resize: vertical;
        }
        .script-output {
            background: #0a0f14;
            border: 1px solid #2a475e;
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
            max-height: 400px;
            overflow: auto;
        }
        .script-output pre {
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            margin: 0;
        }
        .script-output .stdout { color: #a8b4c0; }
        .script-output .stderr { color: #ef5350; }
        .script-output .meta {
            font-size: 11px;
            color: #8f98a0;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #1a2535;
        }
        .script-spinner {
            display: inline-block;
            width: 14px; height: 14px;
            border: 2px solid #2a475e;
            border-top-color: #66c0f4;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 6px;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Policy table */
        .policy-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .policy-table th {
            text-align: left; padding: 8px;
            border-bottom: 1px solid #2a475e; color: #8f98a0; font-weight: 500;
        }
        .policy-table td { padding: 8px; border-bottom: 1px solid #1a2535; }

        /* Terminal */
        #terminal-container {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 4px;
        }

        #terminal-status {
            font-size: 0.85em;
            color: #888;
        }

        #terminal-status.connected {
            color: #4caf50;
        }

        #terminal-status.waiting {
            color: #ff9800;
        }

        #terminal-status.error {
            color: #f44336;
        }

        .report-range-btn.active {
            background: #66c0f4 !important;
            color: #1b2838 !important;
            font-weight: 600;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>
    <!-- Login overlay -->
    <div id="login-overlay" style="position:fixed; top:0; left:0; right:0; bottom:0; background:#0f1923; z-index:1000; display:flex; align-items:center; justify-content:center;">
        <div style="background:#1b2838; border:1px solid #2a475e; border-radius:12px; padding:40px; width:360px; text-align:center;">
            <div style="font-size:24px; font-weight:700; color:#66c0f4; margin-bottom:8px;">Pocket IT</div>
            <div style="font-size:13px; color:#8f98a0; margin-bottom:24px;">IT Dashboard Login</div>
            <div id="login-error" style="display:none; background:#4a1919; color:#ef5350; padding:8px 12px; border-radius:6px; font-size:13px; margin-bottom:16px;"></div>
            <input type="text" id="login-username" placeholder="Username" style="width:100%; background:#0f1923; border:1px solid #2a475e; color:#c7d5e0; padding:10px 14px; border-radius:6px; font-size:14px; margin-bottom:12px;" />
            <input type="password" id="login-password" placeholder="Password" style="width:100%; background:#0f1923; border:1px solid #2a475e; color:#c7d5e0; padding:10px 14px; border-radius:6px; font-size:14px; margin-bottom:16px;" />
            <button onclick="doLogin()" style="width:100%; background:#66c0f4; color:#0f1923; border:none; padding:10px; border-radius:6px; font-size:14px; font-weight:600; cursor:pointer;">Sign In</button>
        </div>
    </div>

    <nav>
        <span class="logo">Pocket IT</span>
        <a href="#" class="nav-link active" data-page="fleet">Fleet</a>
        <a href="#" class="nav-link" data-page="tickets">Tickets</a>
        <a href="#" class="nav-link" data-page="enrollment">Enrollment</a>
        <a href="#" class="nav-link" data-page="alerts">Alerts <span id="nav-alert-badge" style="display:none; background:#ef5350; color:#fff; font-size:10px; padding:2px 6px; border-radius:8px; margin-left:4px;">0</span></a>
        <a href="#" class="nav-link" data-page="reports">Reports</a>
        <span class="spacer"></span>
        <span class="status-badge" id="server-status">Connected</span>
    </nav>

    <div class="container">
        <!-- Fleet page -->
        <div class="page active" id="page-fleet">
            <div class="stats-row">
                <div class="stat-card" onclick="navigateTo('fleet')">
                    <div class="value" id="stat-online">0</div>
                    <div class="label">Devices Online</div>
                </div>
                <div class="stat-card" onclick="navigateTo('fleet')">
                    <div class="value" id="stat-total">0</div>
                    <div class="label">Total Devices</div>
                </div>
                <div class="stat-card" onclick="navigateTo('tickets')">
                    <div class="value" id="stat-tickets-open">0</div>
                    <div class="label">Open Tickets</div>
                </div>
                <div class="stat-card" onclick="navigateTo('tickets')">
                    <div class="value" id="stat-tickets-total">0</div>
                    <div class="label">Total Tickets</div>
                </div>
                <div class="stat-card" onclick="navigateTo('reports')">
                    <div class="value" id="stat-health">—</div>
                    <div class="label">Avg Health Score</div>
                </div>
                <div class="stat-card" onclick="navigateTo('alerts')">
                    <div class="value" id="stat-critical" style="color: #ef5350;">0</div>
                    <div class="label">Critical Devices</div>
                </div>
                <div class="stat-card" onclick="navigateTo('alerts')">
                    <div class="value" id="stat-alerts" style="color: #ef5350;">0</div>
                    <div class="label">Active Alerts</div>
                </div>
            </div>

            <h2 class="section-title">Devices</h2>
            <div class="device-grid" id="device-grid">
                <div class="empty-state">No devices enrolled yet. Generate an enrollment token to get started.</div>
            </div>

        </div>

        <!-- Device detail page -->
        <div class="page" id="page-device">
          <!-- Back button + device header -->
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
            <button class="diag-btn" onclick="backToFleet()" style="font-size:18px; padding:4px 12px;">&larr;</button>
            <h2 id="detail-hostname" style="margin:0; color:#c7d5e0;">Device</h2>
            <span id="detail-status-dot" class="status-dot"></span>
            <span id="detail-device-id" style="font-size:12px; color:#8f98a0; font-family:monospace;"></span>
          </div>

          <!-- Device info cards -->
          <div id="detail-info" class="stats-row" style="margin-bottom:20px;"></div>

          <!-- Two-column layout: tools + chat -->
          <div style="display:grid; grid-template-columns:1fr 400px; gap:20px;">
            <!-- Left column: Diagnostics, File Browser, Scripts -->
            <div>
              <h2 class="section-title">Diagnostics</h2>
              <div style="background:#1b2838; border:1px solid #2a475e; border-radius:8px; padding:16px; margin-bottom:20px;">
                <div class="diag-actions" style="margin-bottom:12px;">
                  <button class="diag-btn" onclick="requestDiag('all')">Run All</button>
                  <button class="diag-btn" onclick="requestDiag('cpu')">CPU</button>
                  <button class="diag-btn" onclick="requestDiag('memory')">Memory</button>
                  <button class="diag-btn" onclick="requestDiag('disk')">Disk</button>
                  <button class="diag-btn" onclick="requestDiag('network')">Network</button>
                </div>
                <div id="detail-diagnostics"></div>
              </div>

              <h2 class="section-title">File Browser</h2>
              <div style="background:#1b2838; border:1px solid #2a475e; border-radius:8px; padding:16px; margin-bottom:20px;">
                <div style="display:flex; gap:8px; margin-bottom:8px;">
                  <input type="text" id="file-browse-path" placeholder="C:\Users\..." style="flex:1; background:#0f1923; border:1px solid #2a475e; color:#c7d5e0; padding:8px 12px; border-radius:4px; font-size:13px; font-family:monospace;" />
                  <button class="diag-btn" onclick="browseFiles()">Browse</button>
                </div>
                <div id="file-browser-area"></div>
              </div>

              <h2 class="section-title">Remote Scripts</h2>
              <div style="background:#1b2838; border:1px solid #2a475e; border-radius:8px; padding:16px; margin-bottom:20px;">
                <div class="script-select" style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                  <select id="script-library-select" style="flex:1; background:#0f1923; border:1px solid #2a475e; color:#c7d5e0; padding:8px; border-radius:4px;">
                    <option value="">-- Select from library --</option>
                  </select>
                  <button class="diag-btn" onclick="runLibraryScript()">Run</button>
                </div>
                <details style="margin-top:8px;">
                  <summary style="cursor:pointer; font-size:13px; color:#8f98a0;">Ad-hoc Script</summary>
                  <div style="margin-top:8px;">
                    <textarea id="adhoc-script" class="script-textarea" placeholder="Enter PowerShell script..." style="width:100%; min-height:80px; background:#0f1923; border:1px solid #2a475e; color:#c7d5e0; padding:8px; border-radius:4px; font-family:monospace; font-size:13px; resize:vertical; box-sizing:border-box;"></textarea>
                    <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
                      <label style="font-size:12px; color:#8f98a0; display:flex; align-items:center; gap:4px;">
                        <input type="checkbox" id="adhoc-elevation" /> Admin
                      </label>
                      <input type="number" id="adhoc-timeout" value="60" min="5" max="300" style="width:60px; background:#0f1923; border:1px solid #2a475e; color:#c7d5e0; padding:4px 6px; border-radius:4px; font-size:12px;" />
                      <span style="font-size:11px; color:#8f98a0;">sec</span>
                      <span style="flex:1;"></span>
                      <button class="diag-btn" onclick="runAdhocScript()">Execute</button>
                    </div>
                  </div>
                </details>
                <div id="script-output-area" style="margin-top:12px;"></div>
              </div>
            </div>

            <!-- Right column: Live Chat -->
            <div>
              <h2 class="section-title">Live Chat</h2>
              <div style="background:#1b2838; border:1px solid #2a475e; border-radius:8px; padding:16px; display:flex; flex-direction:column; height:500px;">
                <div class="chat-area" id="detail-chat" style="flex:1; overflow-y:auto; margin-bottom:12px;"></div>
                <div style="display:flex; gap:8px;">
                  <input type="text" id="detail-chat-input" placeholder="Send message to user..." style="flex:1; background:#0f1923; border:1px solid #2a475e; color:#c7d5e0; padding:8px 12px; border-radius:4px;" />
                  <button class="diag-btn" onclick="sendChatToDevice()" style="background:#66c0f4; color:#1b2838; font-weight:600;">Send</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Full-width: Remote Desktop -->
          <h2 class="section-title" style="margin-top:20px;">Remote Desktop</h2>
          <div style="background:#1b2838; border:1px solid #2a475e; border-radius:8px; padding:16px; margin-bottom:20px;">
            <div id="desktop-controls" style="margin-bottom:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
              <button id="btn-start-desktop" class="diag-btn" onclick="startDesktop()">Connect</button>
              <button id="btn-stop-desktop" class="diag-btn" onclick="stopDesktop()" disabled style="background:#4a1919; color:#ef5350;">Disconnect</button>
              <button class="diag-btn" onclick="popOutDesktop()" title="Open in new tab">&#8599; New Tab</button>
              <span id="desktop-status" style="color:#8f98a0; font-size:13px;">Not connected</span>
              <span style="flex:1;"></span>
              <label style="font-size:12px; color:#8f98a0;">Quality:</label>
              <select id="desktop-quality" onchange="updateDesktopQuality()" style="background:#0f1923; border:1px solid #2a475e; color:#c7d5e0; padding:4px 8px; border-radius:4px; font-size:12px;">
                <option value="30">Low</option>
                <option value="50" selected>Medium</option>
                <option value="75">High</option>
              </select>
              <label style="font-size:12px; color:#8f98a0;">FPS:</label>
              <select id="desktop-fps" onchange="updateDesktopQuality()" style="background:#0f1923; border:1px solid #2a475e; color:#c7d5e0; padding:4px 8px; border-radius:4px; font-size:12px;">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="15">15</option>
                <option value="24">24</option>
              </select>
              <label style="font-size:12px; color:#8f98a0;">Scale:</label>
              <select id="desktop-scale" onchange="updateDesktopQuality()" style="background:#0f1923; border:1px solid #2a475e; color:#c7d5e0; padding:4px 8px; border-radius:4px; font-size:12px;">
                <option value="0.25">25%</option>
                <option value="0.5" selected>50%</option>
                <option value="0.75">75%</option>
                <option value="1.0">100%</option>
              </select>
            </div>
            <div id="desktop-viewer" style="display:none; position:relative; background:#000; border-radius:4px; overflow:hidden; cursor:crosshair;">
              <canvas id="desktop-canvas" style="width:100%; display:block;"></canvas>
            </div>
          </div>

          <!-- Full-width: Remote Terminal -->
          <h2 class="section-title" style="margin-top:20px;">Remote Terminal</h2>
          <div style="background:#1b2838; border:1px solid #2a475e; border-radius:8px; padding:16px; margin-bottom:20px;">
            <div id="terminal-controls" style="margin-bottom:10px; display:flex; align-items:center; gap:10px;">
              <button id="btn-start-terminal" class="diag-btn" onclick="startTerminal()">Open Terminal</button>
              <button id="btn-stop-terminal" class="diag-btn" onclick="stopTerminal()" disabled style="background:#4a1919; color:#ef5350;">Disconnect</button>
              <span id="terminal-status" style="color:#8f98a0; font-size:13px;">Not connected</span>
            </div>
            <div id="terminal-container" style="display:none; height:400px;"></div>
          </div>

          <!-- Danger zone -->
          <div style="padding-top:16px; border-top:1px solid #2a475e;">
            <button class="diag-btn" onclick="removeDevice()" style="background:#4a1919; color:#ef5350;">Remove Device</button>
            <span style="font-size:12px; color:#8f98a0; margin-left:8px;">Removes device and all its data. Device must re-enroll.</span>
          </div>
        </div>

        <!-- Tickets page -->
        <div class="page" id="page-tickets">
            <h2 class="section-title">Support Tickets</h2>
            <ul class="ticket-list" id="ticket-list">
                <div class="empty-state">No tickets yet.</div>
            </ul>
            <!-- Ticket detail panel -->
            <div class="detail-panel" id="ticket-detail">
                <div class="panel-header">
                    <h3 id="ticket-detail-title">Ticket</h3>
                    <button class="close-btn" onclick="closeTicketDetail()">Close</button>
                </div>
                <div id="ticket-detail-info" style="font-size:13px; color:#8f98a0; margin-bottom:16px;"></div>
                <div id="ticket-detail-description" style="background:#0f1923; border:1px solid #2a475e; border-radius:8px; padding:12px; margin-bottom:16px; font-size:13px; line-height:1.5;"></div>
                <div style="display:flex; gap:12px; margin-bottom:16px;">
                    <div>
                        <label style="font-size:12px; color:#8f98a0;">Status</label>
                        <select id="ticket-status-select" onchange="updateTicket('status', this.value)" style="display:block; margin-top:4px; background:#0f1923; border:1px solid #2a475e; color:#c7d5e0; padding:6px 10px; border-radius:4px; font-size:13px;">
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:12px; color:#8f98a0;">Priority</label>
                        <select id="ticket-priority-select" onchange="updateTicket('priority', this.value)" style="display:block; margin-top:4px; background:#0f1923; border:1px solid #2a475e; color:#c7d5e0; padding:6px 10px; border-radius:4px; font-size:13px;">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </div>
                <h4 style="margin:16px 0 8px; color:#c7d5e0;">Comments</h4>
                <div id="ticket-comments" style="margin-bottom:12px;"></div>
                <div class="chat-input-row">
                    <input type="text" id="ticket-comment-input" placeholder="Add a comment..." />
                    <button onclick="addTicketComment()">Comment</button>
                </div>
            </div>
        </div>

        <!-- Enrollment page -->
        <div class="page" id="page-enrollment">
            <h2 class="section-title">Enrollment Tokens</h2>
            <p style="margin-bottom: 16px; color: #8f98a0;">Generate tokens for devices to enroll with Pocket IT.</p>
            <button class="diag-btn" onclick="generateToken()" style="margin-bottom: 16px;">Generate Token</button>
            <div id="token-display" style="display:none; background: #1b2838; border: 1px solid #2a475e; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                <div style="font-size: 13px; color: #8f98a0;">Enrollment Token (one-time use):</div>
                <div id="token-value" style="font-family: monospace; font-size: 18px; color: #66c0f4; margin-top: 8px; user-select: all;"></div>
            </div>
        </div>

        <!-- Alerts page -->
        <div class="page" id="page-alerts">
            <div class="stats-row">
                <div class="stat-card">
                    <div class="value" id="alert-stat-active" style="color: #ef5350;">0</div>
                    <div class="label">Active Alerts</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="alert-stat-critical" style="color: #d50000;">0</div>
                    <div class="label">Critical</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="alert-stat-warning" style="color: #ffa726;">0</div>
                    <div class="label">Warning</div>
                </div>
            </div>

            <div class="alert-filter-row">
                <button class="alert-filter-btn active" onclick="filterAlerts('active')">Active</button>
                <button class="alert-filter-btn" onclick="filterAlerts('all')">All History</button>
            </div>

            <h2 class="section-title">Alerts</h2>
            <ul class="alert-list" id="alert-list">
                <div class="empty-state">No alerts.</div>
            </ul>

            <div style="margin-top: 32px;">
                <h2 class="section-title">Threshold Configuration</h2>
                <div class="alert-section">
                    <table class="threshold-table" id="threshold-table">
                        <thead>
                            <tr>
                                <th>Check Type</th>
                                <th>Field</th>
                                <th>Condition</th>
                                <th>Severity</th>
                                <th>Consecutive</th>
                                <th>Enabled</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="threshold-tbody"></tbody>
                    </table>
                </div>
            </div>

            <div style="margin-top: 24px;">
                <h2 class="section-title">Notification Channels</h2>
                <div class="alert-section">
                    <table class="channel-table" id="channel-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Enabled</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="channel-tbody"></tbody>
                    </table>
                    <button class="diag-btn" onclick="showAddChannelForm()" style="margin-top: 12px;">Add Channel</button>
                    <div id="add-channel-form" style="display: none; margin-top: 12px; background: #0f1923; border: 1px solid #2a475e; border-radius: 6px; padding: 16px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                            <input type="text" id="channel-name" placeholder="Channel name" style="background:#1b2838; border:1px solid #2a475e; color:#c7d5e0; padding:8px; border-radius:4px; font-size:13px;" />
                            <select id="channel-type" style="background:#1b2838; border:1px solid #2a475e; color:#c7d5e0; padding:8px; border-radius:4px; font-size:13px;">
                                <option value="webhook">Webhook</option>
                                <option value="slack">Slack</option>
                                <option value="teams">Teams</option>
                            </select>
                        </div>
                        <input type="text" id="channel-url" placeholder="Webhook URL" style="width:100%; background:#1b2838; border:1px solid #2a475e; color:#c7d5e0; padding:8px; border-radius:4px; font-size:13px; margin-bottom:8px;" />
                        <div style="display: flex; gap: 8px;">
                            <button class="diag-btn" onclick="addChannel()">Save</button>
                            <button class="diag-btn" onclick="hideAddChannelForm()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 24px;">
                <h2 class="section-title">Auto-Remediation Policies</h2>
                <div class="alert-section">
                    <p style="font-size: 12px; color: #8f98a0; margin-bottom: 12px;">When an alert threshold is triggered, auto-remediation can automatically execute a fix action.</p>
                    <table class="policy-table" id="policy-table">
                        <thead>
                            <tr>
                                <th>Threshold</th>
                                <th>Action</th>
                                <th>Parameter</th>
                                <th>Cooldown</th>
                                <th>Consent</th>
                                <th>Enabled</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="policy-tbody"></tbody>
                    </table>
                    <button class="diag-btn" onclick="showAddPolicyForm()" style="margin-top: 12px;">Add Policy</button>
                    <div id="add-policy-form" style="display:none; margin-top:12px; background:#0f1923; border:1px solid #2a475e; border-radius:6px; padding:16px;">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px;">
                            <select id="policy-threshold" style="background:#1b2838; border:1px solid #2a475e; color:#c7d5e0; padding:8px; border-radius:4px; font-size:13px;"></select>
                            <select id="policy-action" style="background:#1b2838; border:1px solid #2a475e; color:#c7d5e0; padding:8px; border-radius:4px; font-size:13px;">
                                <option value="flush_dns">Flush DNS</option>
                                <option value="clear_temp">Clear Temp Files</option>
                                <option value="clear_browser_cache">Clear Browser Cache</option>
                                <option value="restart_spooler">Restart Spooler</option>
                                <option value="repair_network">Repair Network</option>
                                <option value="restart_service">Restart Service</option>
                            </select>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:8px;">
                            <input type="text" id="policy-parameter" placeholder="Parameter (optional)" style="background:#1b2838; border:1px solid #2a475e; color:#c7d5e0; padding:8px; border-radius:4px; font-size:13px;" />
                            <input type="number" id="policy-cooldown" placeholder="Cooldown (min)" value="30" style="background:#1b2838; border:1px solid #2a475e; color:#c7d5e0; padding:8px; border-radius:4px; font-size:13px;" />
                            <label style="display:flex; align-items:center; gap:6px; font-size:13px; color:#c7d5e0;">
                                <input type="checkbox" id="policy-consent" checked /> Require consent
                            </label>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="diag-btn" onclick="addPolicy()">Save</button>
                            <button class="diag-btn" onclick="hideAddPolicyForm()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports page -->
        <div class="page" id="page-reports">
  <!-- Time range selector -->
  <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px; flex-wrap:wrap;">
    <span style="color:#8f98a0; font-size:13px;">Time Range:</span>
    <button class="diag-btn report-range-btn active" data-days="7">7 Days</button>
    <button class="diag-btn report-range-btn" data-days="30">30 Days</button>
    <button class="diag-btn report-range-btn" data-days="90">90 Days</button>
    <div style="flex:1;"></div>
    <button class="diag-btn" onclick="exportReport('csv')" style="background:#2a475e;">Export CSV</button>
    <button class="diag-btn" onclick="exportReport('pdf')" style="background:#2a475e;">Export PDF</button>
  </div>

  <!-- Fleet Health Trend -->
  <h2 class="section-title">Fleet Health Trend</h2>
  <div style="background:#1b2838; border:1px solid #2a475e; border-radius:8px; padding:20px; margin-bottom:20px;">
    <canvas id="chart-fleet-health" height="80"></canvas>
  </div>

  <!-- Alert Summary -->
  <h2 class="section-title">Alert Summary</h2>
  <div class="stats-row" id="alert-summary-stats" style="margin-bottom:16px;">
    <div class="stat-card" onclick="navigateTo('alerts')"><div class="value" id="stat-alert-total">0</div><div class="label">Total Alerts</div></div>
    <div class="stat-card" onclick="navigateTo('alerts')"><div class="value" id="stat-alert-active" style="color:#ef5350;">0</div><div class="label">Active</div></div>
    <div class="stat-card" onclick="navigateTo('alerts')"><div class="value" id="stat-alert-resolved" style="color:#66bb6a;">0</div><div class="label">Resolved</div></div>
    <div class="stat-card" onclick="navigateTo('alerts')"><div class="value" id="stat-alert-mttr">-</div><div class="label">MTTR (hours)</div></div>
  </div>
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
    <div style="background:#1b2838; border:1px solid #2a475e; border-radius:8px; padding:20px;">
      <canvas id="chart-alerts-per-day" height="100"></canvas>
    </div>
    <div style="background:#1b2838; border:1px solid #2a475e; border-radius:8px; padding:20px;">
      <canvas id="chart-alerts-by-severity" height="100"></canvas>
    </div>
  </div>

  <!-- Ticket Summary -->
  <h2 class="section-title">Ticket Summary</h2>
  <div class="stats-row" id="ticket-summary-stats" style="margin-bottom:16px;">
    <div class="stat-card" onclick="navigateTo('tickets')"><div class="value" id="stat-ticket-total">0</div><div class="label">Total Tickets</div></div>
    <div class="stat-card" onclick="navigateTo('tickets')"><div class="value" id="stat-ticket-open" style="color:#ffa726;">0</div><div class="label">Open</div></div>
    <div class="stat-card" onclick="navigateTo('tickets')"><div class="value" id="stat-ticket-resolved" style="color:#66bb6a;">0</div><div class="label">Resolved</div></div>
    <div class="stat-card" onclick="navigateTo('tickets')"><div class="value" id="stat-ticket-avgres">-</div><div class="label">Avg Resolution (hours)</div></div>
  </div>
  <div style="background:#1b2838; border:1px solid #2a475e; border-radius:8px; padding:20px; margin-bottom:20px;">
    <canvas id="chart-tickets-per-day" height="80"></canvas>
  </div>

  <!-- Device Drill-down -->
  <h2 class="section-title">Device Drill-down</h2>
  <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
    <select id="report-device-select" style="background:#0f1923; border:1px solid #2a475e; color:#c7d5e0; padding:8px 12px; border-radius:4px; min-width:200px;">
      <option value="">Select a device...</option>
    </select>
    <select id="report-metric-select" style="background:#0f1923; border:1px solid #2a475e; color:#c7d5e0; padding:8px 12px; border-radius:4px;">
      <option value="cpu">CPU Usage</option>
      <option value="memory">Memory Usage</option>
      <option value="disk">Disk Usage</option>
    </select>
    <button class="diag-btn" onclick="loadDeviceMetrics()">Load</button>
  </div>
  <div style="background:#1b2838; border:1px solid #2a475e; border-radius:8px; padding:20px; margin-bottom:20px;">
    <canvas id="chart-device-metrics" height="80"></canvas>
    <div id="device-metrics-empty" class="empty-state" style="display:none;">Select a device and metric to view trends</div>
  </div>

  <!-- Scheduled Reports -->
  <h2 class="section-title">Scheduled Reports</h2>
  <div style="margin-bottom:12px;">
    <button class="diag-btn" onclick="showScheduleForm()" style="background:#66c0f4; color:#1b2838; font-weight:600;">+ New Schedule</button>
  </div>
  <div id="schedule-form" style="display:none; background:#1b2838; border:1px solid #2a475e; border-radius:8px; padding:20px; margin-bottom:16px;">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
      <div>
        <label style="color:#8f98a0; font-size:12px; display:block; margin-bottom:4px;">Name</label>
        <input type="text" id="sched-name" style="background:#0f1923; border:1px solid #2a475e; color:#c7d5e0; padding:8px; border-radius:4px; width:100%; box-sizing:border-box;">
      </div>
      <div>
        <label style="color:#8f98a0; font-size:12px; display:block; margin-bottom:4px;">Report Type</label>
        <select id="sched-type" style="background:#0f1923; border:1px solid #2a475e; color:#c7d5e0; padding:8px; border-radius:4px; width:100%; box-sizing:border-box;">
          <option value="fleet_health">Fleet Health</option>
          <option value="alert_summary">Alert Summary</option>
          <option value="ticket_summary">Ticket Summary</option>
          <option value="device_metrics">Device Metrics</option>
        </select>
      </div>
      <div>
        <label style="color:#8f98a0; font-size:12px; display:block; margin-bottom:4px;">Cron Schedule</label>
        <input type="text" id="sched-cron" placeholder="0 8 * * 1" style="background:#0f1923; border:1px solid #2a475e; color:#c7d5e0; padding:8px; border-radius:4px; width:100%; box-sizing:border-box;">
        <span style="color:#8f98a0; font-size:11px;">e.g. 0 8 * * 1 = Mon 8am</span>
      </div>
      <div>
        <label style="color:#8f98a0; font-size:12px; display:block; margin-bottom:4px;">Format</label>
        <select id="sched-format" style="background:#0f1923; border:1px solid #2a475e; color:#c7d5e0; padding:8px; border-radius:4px; width:100%; box-sizing:border-box;">
          <option value="csv">CSV</option>
          <option value="pdf">PDF</option>
        </select>
      </div>
    </div>
    <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
      <button class="diag-btn" onclick="hideScheduleForm()">Cancel</button>
      <button class="diag-btn" onclick="saveSchedule()" style="background:#66c0f4; color:#1b2838; font-weight:600;">Save</button>
    </div>
  </div>
  <div id="schedules-list"></div>

  <!-- Report History -->
  <h2 class="section-title" style="margin-top:24px;">Report History</h2>
  <div id="report-history-list"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Dashboard JS
        const API = '';
        let socket = null;
        let currentDeviceId = null;
        let currentTicketId = null;
        let authToken = sessionStorage.getItem('pocket_it_token') || '';
        let term = null;
        let fitAddon = null;
        let terminalDeviceId = null;
        let terminalLineBuffer = '';
        let desktopDeviceId = null;
        let desktopActive = false;
        let desktopCanvas = null;
        let desktopCtx = null;
        let desktopImg = new Image();

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ---- Auth ----
        async function fetchWithAuth(url, options = {}) {
            if (authToken) {
                options.headers = { ...options.headers, 'Authorization': 'Bearer ' + authToken };
            }
            const res = await fetch(url, options);
            if (res.status === 401 && authToken) {
                sessionStorage.removeItem('pocket_it_token');
                authToken = '';
                showLogin();
            }
            return res;
        }

        function showLogin() {
            document.getElementById('login-overlay').style.display = 'flex';
        }

        function hideLogin() {
            document.getElementById('login-overlay').style.display = 'none';
        }

        async function doLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.style.display = 'none';

            try {
                const res = await fetch(`${API}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (res.ok && data.token) {
                    authToken = data.token;
                    sessionStorage.setItem('pocket_it_token', authToken);
                    hideLogin();
                    initSocket();
                    loadFleet();
                } else {
                    errorEl.textContent = data.error || 'Login failed';
                    errorEl.style.display = 'block';
                }
            } catch (err) {
                errorEl.textContent = 'Connection error';
                errorEl.style.display = 'block';
            }
        }

        document.getElementById('login-password').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') doLogin();
        });

        // ---- Navigation ----
        function navigateTo(page) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const navLink = document.querySelector(`[data-page="${page}"]`);
            if (navLink) navLink.classList.add('active');
            document.getElementById('page-' + page).classList.add('active');
            if (page === 'fleet') loadFleet();
            if (page === 'tickets') loadTickets();
            if (page === 'alerts') loadAlerts();
            if (page === 'reports') loadReports();
        }

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo(link.dataset.page);
            });
        });

        // ---- Socket.IO ----
        function initSocket() {
            if (socket) socket.disconnect();
            const opts = {};
            if (authToken) opts.auth = { token: authToken };
            socket = io('/it', opts);

            socket.on('connect', () => {
                document.getElementById('server-status').textContent = 'Connected';
                document.getElementById('server-status').style.background = '#1b5e20';
                loadFleet();
            });

            socket.on('disconnect', () => {
                document.getElementById('server-status').textContent = 'Disconnected';
                document.getElementById('server-status').style.background = '#4a1919';
            });

            socket.on('device_status_changed', () => loadFleet());

            socket.on('device_chat_update', (data) => {
                if (data.deviceId === currentDeviceId) {
                    appendChatMessage(data.message.sender, data.message.content);
                    if (data.response) {
                        appendChatMessage(data.response.sender, data.response.text);
                    }
                }
            });

            socket.on('device_chat_history', (data) => {
                if (data.deviceId === currentDeviceId) {
                    const chatEl = document.getElementById('detail-chat');
                    chatEl.innerHTML = '';
                    data.messages.forEach(m => appendChatMessage(m.sender, m.content));
                }
            });

            socket.on('device_diagnostic_update', (data) => {
                if (data.deviceId === currentDeviceId) {
                    showDiagnosticResults(data);
                }
                if (data.healthScore !== undefined) {
                    loadFleet(); // Refresh stats to show updated health score
                }
            });

            socket.on('ticket_created', () => loadFleet());

            socket.on('new_alert', (data) => {
                loadAlerts();
            });

            socket.on('alert_stats_updated', (data) => {
                // Update badge
                const badge = document.getElementById('nav-alert-badge');
                if (data.activeCount > 0) {
                    badge.textContent = data.activeCount;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
                // Update stats if on alerts page
                document.getElementById('alert-stat-active').textContent = data.activeCount || 0;
                document.getElementById('alert-stat-critical').textContent = data.criticalCount || 0;
                document.getElementById('alert-stat-warning').textContent = data.warningCount || 0;
            });

            socket.on('file_browse_result', (data) => {
                if (data.deviceId === currentDeviceId) renderFileBrowser(data);
            });

            socket.on('file_read_result', (data) => {
                if (data.deviceId === currentDeviceId) renderFileContent(data);
            });

            socket.on('script_result', (data) => {
                if (data.deviceId === currentDeviceId) renderScriptResult(data);
            });

            socket.on('auto_remediation_triggered', () => {
                loadAlerts();
            });

            socket.on('terminal_started', (data) => {
                if (data.deviceId !== terminalDeviceId) return;
                document.getElementById('terminal-container').style.display = 'block';
                term = new Terminal({
                    cursorBlink: true,
                    theme: {
                        background: '#1e1e1e',
                        foreground: '#d4d4d4'
                    },
                    fontSize: 14,
                    fontFamily: 'Consolas, "Courier New", monospace'
                });
                fitAddon = new FitAddon.FitAddon();
                term.loadAddon(fitAddon);
                term.open(document.getElementById('terminal-container'));
                fitAddon.fit();
                // Line-buffered input with local echo (no PTY — PowerShell won't echo)
                terminalLineBuffer = '';
                term.onData(d => {
                    if (d === '\r') {
                        // Enter: send accumulated line, echo newline
                        term.write('\r\n');
                        socket.emit('terminal_input', { deviceId: terminalDeviceId, input: terminalLineBuffer });
                        terminalLineBuffer = '';
                    } else if (d === '\x7f' || d === '\b') {
                        // Backspace: remove last char, erase on screen
                        if (terminalLineBuffer.length > 0) {
                            terminalLineBuffer = terminalLineBuffer.slice(0, -1);
                            term.write('\b \b');
                        }
                    } else if (d === '\x03') {
                        // Ctrl+C: send break signal, clear buffer
                        term.write('^C\r\n');
                        terminalLineBuffer = '';
                        socket.emit('terminal_input', { deviceId: terminalDeviceId, input: '\x03' });
                    } else if (d >= ' ') {
                        // Printable char: echo locally and buffer
                        terminalLineBuffer += d;
                        term.write(d);
                    }
                    // Ignore other control sequences (arrows, etc.)
                });
                const statusEl = document.getElementById('terminal-status');
                statusEl.textContent = 'Connected';
                statusEl.className = 'connected';
                document.getElementById('btn-start-terminal').disabled = true;
                document.getElementById('btn-stop-terminal').disabled = false;
            });

            socket.on('terminal_output', (data) => {
                if (data.deviceId !== terminalDeviceId) return;
                if (term) term.write(data.output);
            });

            socket.on('terminal_stopped', (data) => {
                if (data.deviceId !== terminalDeviceId) return;
                if (term) {
                    term.write('\r\n\r\n[Session ended: ' + (data.reason || 'unknown') + ']\r\n');
                }
                setTimeout(() => cleanupTerminal(), 1000);
            });

            socket.on('terminal_denied', (data) => {
                if (data.deviceId !== terminalDeviceId) return;
                const statusEl = document.getElementById('terminal-status');
                statusEl.textContent = 'User denied terminal access';
                statusEl.className = 'error';
                setTimeout(() => {
                    statusEl.textContent = 'Not connected';
                    statusEl.className = '';
                }, 3000);
                document.getElementById('btn-start-terminal').disabled = false;
                document.getElementById('btn-stop-terminal').disabled = true;
                terminalDeviceId = null;
            });

            socket.on('desktop_started', (data) => {
                if (data.deviceId !== desktopDeviceId) return;
                desktopActive = true;
                desktopCanvas = document.getElementById('desktop-canvas');
                desktopCtx = desktopCanvas.getContext('2d');
                document.getElementById('desktop-viewer').style.display = 'block';
                document.getElementById('desktop-status').textContent = 'Connected';
                document.getElementById('desktop-status').style.color = '#66bb6a';
                document.getElementById('btn-start-desktop').disabled = true;
                document.getElementById('btn-stop-desktop').disabled = false;
            });

            socket.on('desktop_frame', (data) => {
                if (data.deviceId !== desktopDeviceId || !desktopActive) return;
                desktopImg.onload = function() {
                    if (!desktopCanvas) return;
                    // Set canvas internal resolution to match frame
                    if (desktopCanvas.width !== data.width || desktopCanvas.height !== data.height) {
                        desktopCanvas.width = data.width;
                        desktopCanvas.height = data.height;
                    }
                    desktopCtx.drawImage(desktopImg, 0, 0);
                };
                desktopImg.src = 'data:image/jpeg;base64,' + data.frame;
            });

            socket.on('desktop_stopped', (data) => {
                if (data.deviceId !== desktopDeviceId) return;
                cleanupDesktop();
                document.getElementById('desktop-status').textContent = 'Disconnected: ' + (data.reason || 'session ended');
            });

            socket.on('desktop_denied', (data) => {
                if (data.deviceId !== desktopDeviceId) return;
                cleanupDesktop();
                document.getElementById('desktop-status').textContent = 'Denied by device';
                document.getElementById('desktop-status').style.color = '#ef5350';
            });
        }

        // ---- Fleet ----
        async function loadFleet() {
            try {
                const [statsRes, devicesRes] = await Promise.all([
                    fetchWithAuth(`${API}/api/admin/stats`),
                    fetchWithAuth(`${API}/api/devices`)
                ]);
                const stats = await statsRes.json();
                const devices = await devicesRes.json();

                document.getElementById('stat-online').textContent = stats.onlineDevices || 0;
                document.getElementById('stat-total').textContent = stats.totalDevices || 0;
                document.getElementById('stat-tickets-open').textContent = stats.openTickets || 0;
                document.getElementById('stat-tickets-total').textContent = stats.totalTickets || 0;
                document.getElementById('stat-health').textContent = stats.averageHealth !== null && stats.averageHealth !== undefined ? stats.averageHealth + '%' : '—';
                document.getElementById('stat-critical').textContent = stats.criticalDevices || 0;

                // Load alert stats for fleet page
                try {
                    const alertStatsRes = await fetchWithAuth(`${API}/api/alerts/stats`);
                    const alertStats = await alertStatsRes.json();
                    document.getElementById('stat-alerts').textContent = alertStats.activeCount || 0;

                    // Update nav badge too
                    const badge = document.getElementById('nav-alert-badge');
                    if (alertStats.activeCount > 0) {
                        badge.textContent = alertStats.activeCount;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                } catch (err) {
                    console.error('Failed to load alert stats:', err);
                }

                const grid = document.getElementById('device-grid');
                if (devices.length === 0) {
                    grid.innerHTML = '<div class="empty-state">No devices enrolled yet.</div>';
                    return;
                }
                grid.innerHTML = devices.map(d => {
                    const hs = d.health_score;
                    const healthClass = hs === null || hs === undefined ? 'unknown' : hs >= 75 ? 'good' : hs >= 40 ? 'warning' : 'critical';
                    const healthLabel = hs !== null && hs !== undefined ? hs + '%' : 'No data';
                    return `
                    <div class="device-card" onclick="openDevice('${d.device_id}')">
                        <div class="device-header">
                            <span class="hostname">${escapeHtml(d.hostname || 'Unknown')}</span>
                            <span class="status-dot ${d.status || 'offline'}"></span>
                        </div>
                        <div class="device-id">${escapeHtml(d.device_id.substring(0, 8))}...</div>
                        <div class="last-seen">Last seen: ${d.last_seen ? new Date(d.last_seen).toLocaleString() : 'Never'}</div>
                        <div class="health-bar"><div class="fill ${healthClass}" style="width: ${hs !== null && hs !== undefined ? hs : 0}%"></div></div>
                        <div style="font-size: 11px; color: #8f98a0; margin-top: 4px;">Health: ${healthLabel}</div>
                    </div>`;
                }).join('');
            } catch (err) {
                console.error('Failed to load fleet:', err);
            }
        }

        // ---- Tickets ----
        async function loadTickets() {
            try {
                const res = await fetchWithAuth(`${API}/api/tickets`);
                const tickets = await res.json();
                const list = document.getElementById('ticket-list');
                if (tickets.length === 0) {
                    list.innerHTML = '<div class="empty-state">No tickets yet.</div>';
                    return;
                }
                list.innerHTML = tickets.map(t => `
                    <li class="ticket-item" onclick="openTicket(${t.id})" style="cursor:pointer;">
                        <div class="priority ${t.priority}"></div>
                        <div class="ticket-info">
                            <div class="ticket-title">${escapeHtml(t.title)}</div>
                            <div class="ticket-meta">
                                Device: ${escapeHtml((t.device_id || '').substring(0, 8))}... |
                                Created: ${new Date(t.created_at).toLocaleString()}
                            </div>
                        </div>
                        <span class="ticket-status ${t.status}">${t.status}</span>
                    </li>
                `).join('');
            } catch (err) {
                console.error('Failed to load tickets:', err);
            }
        }

        async function openTicket(ticketId) {
            currentTicketId = ticketId;
            const panel = document.getElementById('ticket-detail');
            panel.classList.add('active');

            try {
                const res = await fetchWithAuth(`${API}/api/tickets/${ticketId}`);
                const ticket = await res.json();

                document.getElementById('ticket-detail-title').textContent = ticket.title;
                document.getElementById('ticket-detail-info').innerHTML = `
                    #${ticket.id} | Device: <code>${escapeHtml((ticket.device_id || '').substring(0, 12))}...</code> |
                    Created: ${new Date(ticket.created_at).toLocaleString()}
                    ${ticket.ai_summary ? ' | <em>AI-generated</em>' : ''}
                `;
                document.getElementById('ticket-detail-description').textContent =
                    ticket.description || ticket.ai_summary || 'No description provided.';

                document.getElementById('ticket-status-select').value = ticket.status || 'open';
                document.getElementById('ticket-priority-select').value = ticket.priority || 'medium';

                // Render comments
                const commentsEl = document.getElementById('ticket-comments');
                if (ticket.comments && ticket.comments.length > 0) {
                    commentsEl.innerHTML = ticket.comments.map(c => `
                        <div style="background:#0f1923; border:1px solid #2a475e; border-radius:6px; padding:10px; margin-bottom:8px;">
                            <div style="font-size:12px; color:#8f98a0;">${escapeHtml(c.author)} &mdash; ${new Date(c.created_at).toLocaleString()}</div>
                            <div style="font-size:13px; margin-top:4px;">${escapeHtml(c.content)}</div>
                        </div>
                    `).join('');
                } else {
                    commentsEl.innerHTML = '<div style="font-size:13px; color:#8f98a0;">No comments yet.</div>';
                }
            } catch (err) {
                console.error('Failed to load ticket:', err);
            }
        }

        function closeTicketDetail() {
            document.getElementById('ticket-detail').classList.remove('active');
            currentTicketId = null;
        }

        async function updateTicket(field, value) {
            if (!currentTicketId) return;
            try {
                await fetchWithAuth(`${API}/api/tickets/${currentTicketId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: value })
                });
                loadTickets(); // refresh list
            } catch (err) {
                console.error('Failed to update ticket:', err);
            }
        }

        async function addTicketComment() {
            const input = document.getElementById('ticket-comment-input');
            const content = input.value.trim();
            if (!content || !currentTicketId) return;

            try {
                await fetchWithAuth(`${API}/api/tickets/${currentTicketId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, author: 'IT Staff' })
                });
                input.value = '';
                openTicket(currentTicketId); // refresh detail
            } catch (err) {
                console.error('Failed to add comment:', err);
            }
        }

        // ---- Device Detail ----
        function openDevice(deviceId) {
            cleanupTerminal();
            currentDeviceId = deviceId;

            // Switch to device page (same as nav page switching)
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-device').classList.add('active');

            document.getElementById('detail-hostname').textContent = 'Loading...';
            document.getElementById('detail-device-id').textContent = '';
            document.getElementById('detail-chat').innerHTML = '';
            document.getElementById('detail-diagnostics').innerHTML = '';

            fetchWithAuth(`${API}/api/devices/${deviceId}`).then(r => r.json()).then(d => {
                document.getElementById('detail-hostname').textContent = d.hostname || deviceId;
                document.getElementById('detail-device-id').textContent = d.device_id;
                const statusDot = document.getElementById('detail-status-dot');
                statusDot.className = 'status-dot ' + (d.status || 'offline');

                // Render info as stat cards
                const infoHtml = [];
                if (d.os_version) infoHtml.push(`<div class="stat-card" onclick="navigateTo('reports')"><div class="value" style="font-size:16px;">${escapeHtml(d.os_version)}</div><div class="label">OS</div></div>`);
                if (d.cpu_model) infoHtml.push(`<div class="stat-card" onclick="navigateTo('reports')"><div class="value" style="font-size:16px;">${escapeHtml(d.cpu_model)}${d.processor_count ? ' (' + d.processor_count + ' cores)' : ''}</div><div class="label">CPU</div></div>`);
                if (d.total_ram_gb) infoHtml.push(`<div class="stat-card" onclick="navigateTo('reports')"><div class="value">${d.total_ram_gb} GB</div><div class="label">RAM</div></div>`);
                if (d.total_disk_gb) infoHtml.push(`<div class="stat-card" onclick="navigateTo('reports')"><div class="value">${d.total_disk_gb} GB</div><div class="label">Disk</div></div>`);
                if (d.health_score !== null && d.health_score !== undefined) {
                    const color = d.health_score >= 75 ? '#66bb6a' : d.health_score >= 40 ? '#ffa726' : '#ef5350';
                    infoHtml.push(`<div class="stat-card" onclick="navigateTo('reports')"><div class="value" style="color:${color};">${d.health_score}%</div><div class="label">Health Score</div></div>`);
                }
                document.getElementById('detail-info').innerHTML = infoHtml.join('');
            });

            if (socket) {
                socket.emit('watch_device', { deviceId });
            }

            loadScriptLibrary();
            document.getElementById('file-browse-path').value = '';
            document.getElementById('file-browser-area').innerHTML = '';
            document.getElementById('script-output-area').innerHTML = '';
        }

        function backToFleet() {
            cleanupTerminal();
            cleanupDesktop();
            if (socket && currentDeviceId) {
                socket.emit('unwatch_device', { deviceId: currentDeviceId });
            }
            currentDeviceId = null;
            // Switch back to fleet page
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelector('[data-page="fleet"]').classList.add('active');
            document.getElementById('page-fleet').classList.add('active');
            loadFleet();
        }

        function closeDetail() { backToFleet(); }

        function startTerminal() {
            if (!currentDeviceId || !socket) return;
            terminalDeviceId = currentDeviceId;
            const statusEl = document.getElementById('terminal-status');
            statusEl.textContent = 'Waiting for user approval...';
            statusEl.className = 'waiting';
            document.getElementById('btn-start-terminal').disabled = true;
            document.getElementById('btn-stop-terminal').disabled = false;
            socket.emit('start_terminal', { deviceId: terminalDeviceId });
        }

        function stopTerminal() {
            if (!terminalDeviceId || !socket) return;
            socket.emit('stop_terminal', { deviceId: terminalDeviceId });
            cleanupTerminal();
        }

        function cleanupTerminal() {
            if (term) {
                term.dispose();
                term = null;
            }
            fitAddon = null;
            terminalLineBuffer = '';
            document.getElementById('terminal-container').style.display = 'none';
            const statusEl = document.getElementById('terminal-status');
            statusEl.textContent = 'Not connected';
            statusEl.className = '';
            document.getElementById('btn-stop-terminal').disabled = true;
            document.getElementById('btn-start-terminal').disabled = false;
            terminalDeviceId = null;
        }

        window.addEventListener('resize', () => {
            if (fitAddon) fitAddon.fit();
        });

        function startDesktop() {
            if (!currentDeviceId || !socket) return;
            desktopDeviceId = currentDeviceId;
            const statusEl = document.getElementById('desktop-status');
            statusEl.textContent = 'Connecting...';
            statusEl.style.color = '#ffa726';
            socket.emit('start_desktop', { deviceId: desktopDeviceId });
        }

        function stopDesktop() {
            if (!desktopDeviceId || !socket) return;
            socket.emit('stop_desktop', { deviceId: desktopDeviceId });
            cleanupDesktop();
        }

        function cleanupDesktop() {
            desktopActive = false;
            desktopDeviceId = null;
            desktopCanvas = null;
            desktopCtx = null;
            document.getElementById('desktop-viewer').style.display = 'none';
            document.getElementById('btn-start-desktop').disabled = false;
            document.getElementById('btn-stop-desktop').disabled = true;
            document.getElementById('desktop-status').textContent = 'Not connected';
            document.getElementById('desktop-status').style.color = '#8f98a0';
        }

        function popOutDesktop() {
            if (!currentDeviceId) return;
            const nameEl = document.getElementById('detail-hostname');
            const name = nameEl ? encodeURIComponent(nameEl.textContent) : '';
            window.open('/dashboard/desktop.html?deviceId=' + encodeURIComponent(currentDeviceId) + '&name=' + name, '_blank');
        }

        function updateDesktopQuality() {
            if (!desktopDeviceId || !socket || !desktopActive) return;
            const quality = parseInt(document.getElementById('desktop-quality').value);
            const fps = parseInt(document.getElementById('desktop-fps').value);
            const scale = parseFloat(document.getElementById('desktop-scale').value);
            socket.emit('desktop_quality', { deviceId: desktopDeviceId, quality, fps, scale });
        }

        // Desktop mouse/keyboard event handlers
        function setupDesktopInput() {
            const canvas = document.getElementById('desktop-canvas');
            const viewer = document.getElementById('desktop-viewer');

            function getCanvasCoords(e) {
                const rect = canvas.getBoundingClientRect();
                return {
                    x: (e.clientX - rect.left) / rect.width,
                    y: (e.clientY - rect.top) / rect.height
                };
            }

            canvas.addEventListener('mousedown', (e) => {
                if (!desktopActive || !socket) return;
                e.preventDefault();
                const pos = getCanvasCoords(e);
                const btn = e.button === 2 ? 'right' : e.button === 1 ? 'middle' : 'left';
                socket.emit('desktop_mouse', { deviceId: desktopDeviceId, x: pos.x, y: pos.y, button: btn, action: 'down' });
            });

            canvas.addEventListener('mouseup', (e) => {
                if (!desktopActive || !socket) return;
                e.preventDefault();
                const pos = getCanvasCoords(e);
                const btn = e.button === 2 ? 'right' : e.button === 1 ? 'middle' : 'left';
                socket.emit('desktop_mouse', { deviceId: desktopDeviceId, x: pos.x, y: pos.y, button: btn, action: 'up' });
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!desktopActive || !socket) return;
                // Throttle mouse moves to ~30 per second
                if (!canvas._lastMove || Date.now() - canvas._lastMove > 33) {
                    canvas._lastMove = Date.now();
                    const pos = getCanvasCoords(e);
                    socket.emit('desktop_mouse', { deviceId: desktopDeviceId, x: pos.x, y: pos.y, button: 'left', action: 'move' });
                }
            });

            canvas.addEventListener('wheel', (e) => {
                if (!desktopActive || !socket) return;
                e.preventDefault();
                const pos = getCanvasCoords(e);
                socket.emit('desktop_mouse', { deviceId: desktopDeviceId, x: pos.x, y: pos.y, button: e.deltaY < 0 ? 'up' : 'down', action: 'scroll' });
            }, { passive: false });

            canvas.addEventListener('contextmenu', (e) => e.preventDefault());

            // Keyboard (only when desktop viewer is focused)
            viewer.setAttribute('tabindex', '0');
            viewer.addEventListener('keydown', (e) => {
                if (!desktopActive || !socket) return;
                e.preventDefault();
                socket.emit('desktop_keyboard', { deviceId: desktopDeviceId, vkCode: e.keyCode, action: 'down' });
            });

            viewer.addEventListener('keyup', (e) => {
                if (!desktopActive || !socket) return;
                e.preventDefault();
                socket.emit('desktop_keyboard', { deviceId: desktopDeviceId, vkCode: e.keyCode, action: 'up' });
            });
        }

        function appendChatMessage(sender, content) {
            const chatEl = document.getElementById('detail-chat');
            const msg = document.createElement('div');
            msg.className = 'msg';
            msg.innerHTML = `<span class="sender-tag ${escapeHtml(sender)}">${escapeHtml(sender)}:</span> ${escapeHtml(content)}`;
            chatEl.appendChild(msg);
            chatEl.scrollTop = chatEl.scrollHeight;
        }

        function sendChatToDevice() {
            const input = document.getElementById('detail-chat-input');
            const content = input.value.trim();
            if (!content || !currentDeviceId || !socket) return;
            socket.emit('chat_to_device', { deviceId: currentDeviceId, content });
            appendChatMessage('it_tech', content);
            input.value = '';
        }

        document.getElementById('detail-chat-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendChatToDevice();
        });

        function requestDiag(checkType) {
            if (!currentDeviceId || !socket) return;
            socket.emit('request_diagnostic', { deviceId: currentDeviceId, checkType });
        }

        function showDiagnosticResults(data) {
            const el = document.getElementById('detail-diagnostics');
            el.innerHTML = `<div style="font-size: 13px; color: #8f98a0;">
                Results for ${data.checkType} (${new Date().toLocaleTimeString()}):</div>
                <pre style="background: #0f1923; padding: 12px; border-radius: 6px; margin-top: 8px; font-size: 12px; overflow: auto;">${JSON.stringify(data.results, null, 2)}</pre>`;
        }

        async function generateToken() {
            try {
                const res = await fetchWithAuth(`${API}/api/enrollment/token`, { method: 'POST' });
                const data = await res.json();
                document.getElementById('token-display').style.display = 'block';
                document.getElementById('token-value').textContent = data.token;
            } catch (err) {
                alert('Failed to generate token: ' + err.message);
            }
        }

        async function removeDevice() {
            if (!currentDeviceId) return;
            if (!confirm('Remove this device and all its chat/diagnostic data? The device will need to re-enroll.')) return;
            try {
                const res = await fetchWithAuth(`${API}/api/devices/${currentDeviceId}`, { method: 'DELETE' });
                if (res.ok) {
                    closeDetail();
                    loadFleet();
                } else {
                    const data = await res.json();
                    alert('Failed: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Failed to remove device: ' + err.message);
            }
        }

        // ---- Alerts ----
        let alertFilter = 'active';

        async function loadAlerts() {
            try {
                // Load stats
                const statsRes = await fetchWithAuth(`${API}/api/alerts/stats`);
                const stats = await statsRes.json();
                document.getElementById('alert-stat-active').textContent = stats.activeCount || 0;
                document.getElementById('alert-stat-critical').textContent = stats.criticalCount || 0;
                document.getElementById('alert-stat-warning').textContent = stats.warningCount || 0;

                // Update nav badge
                const badge = document.getElementById('nav-alert-badge');
                if (stats.activeCount > 0) {
                    badge.textContent = stats.activeCount;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }

                // Load alerts
                const url = alertFilter === 'active'
                    ? `${API}/api/alerts?status=active`
                    : `${API}/api/alerts?limit=100`;
                const alertsRes = await fetchWithAuth(url);
                const alerts = await alertsRes.json();

                const list = document.getElementById('alert-list');
                if (alerts.length === 0) {
                    list.innerHTML = '<div class="empty-state">No alerts.</div>';
                    return;
                }

                list.innerHTML = alerts.map(a => `
                    <li class="alert-item">
                        <div class="severity-indicator ${a.severity}"></div>
                        <div class="alert-info">
                            <div class="alert-title">${escapeHtml(a.message)}</div>
                            <div class="alert-meta">
                                Device: ${escapeHtml(a.hostname || (a.device_id || '').substring(0, 8))} |
                                Check: ${escapeHtml(a.check_type)} |
                                ${a.triggered_at ? new Date(a.triggered_at).toLocaleString() : ''}
                                ${a.status === 'acknowledged' ? ' | Acknowledged by ' + escapeHtml(a.acknowledged_by || 'staff') : ''}
                                ${a.status === 'resolved' ? ' | Resolved ' + (a.resolved_at ? new Date(a.resolved_at).toLocaleString() : '') : ''}
                            </div>
                        </div>
                        <div class="alert-actions">
                            ${a.status === 'active' ? `<button onclick="acknowledgeAlert(${a.id})">Acknowledge</button>` : ''}
                            ${a.status !== 'resolved' ? `<button class="resolve-btn" onclick="resolveAlert(${a.id})">Resolve</button>` : ''}
                        </div>
                    </li>
                `).join('');

                // Load thresholds
                await loadThresholds();
                // Load channels
                await loadChannels();
                await loadPolicies();
            } catch (err) {
                console.error('Failed to load alerts:', err);
            }
        }

        function filterAlerts(filter) {
            alertFilter = filter;
            document.querySelectorAll('.alert-filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            loadAlerts();
        }

        async function acknowledgeAlert(alertId) {
            try {
                await fetchWithAuth(`${API}/api/alerts/${alertId}/acknowledge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ acknowledgedBy: 'IT Staff' })
                });
                loadAlerts();
            } catch (err) {
                console.error('Failed to acknowledge alert:', err);
            }
        }

        async function resolveAlert(alertId) {
            try {
                await fetchWithAuth(`${API}/api/alerts/${alertId}/resolve`, { method: 'POST' });
                loadAlerts();
            } catch (err) {
                console.error('Failed to resolve alert:', err);
            }
        }

        async function loadThresholds() {
            try {
                const res = await fetchWithAuth(`${API}/api/alerts/thresholds`);
                const thresholds = await res.json();
                const tbody = document.getElementById('threshold-tbody');
                tbody.innerHTML = thresholds.map(t => `
                    <tr>
                        <td>${escapeHtml(t.check_type)}</td>
                        <td>${escapeHtml(t.field_path)}</td>
                        <td>${escapeHtml(t.operator)} ${t.threshold_value}</td>
                        <td><span style="color: ${t.severity === 'critical' ? '#ef5350' : '#ffa726'}">${t.severity}</span></td>
                        <td>${t.consecutive_required}x</td>
                        <td>
                            <button class="toggle-btn ${t.enabled ? 'active' : ''}"
                                onclick="toggleThreshold(${t.id}, ${t.enabled ? 0 : 1})">
                                ${t.enabled ? 'ON' : 'OFF'}
                            </button>
                        </td>
                        <td><button class="toggle-btn" onclick="deleteThreshold(${t.id})">Delete</button></td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Failed to load thresholds:', err);
            }
        }

        async function toggleThreshold(id, enabled) {
            try {
                await fetchWithAuth(`${API}/api/alerts/thresholds/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                loadThresholds();
            } catch (err) {
                console.error('Failed to toggle threshold:', err);
            }
        }

        async function deleteThreshold(id) {
            if (!confirm('Delete this threshold?')) return;
            try {
                await fetchWithAuth(`${API}/api/alerts/thresholds/${id}`, { method: 'DELETE' });
                loadThresholds();
            } catch (err) {
                console.error('Failed to delete threshold:', err);
            }
        }

        async function loadChannels() {
            try {
                const res = await fetchWithAuth(`${API}/api/alerts/channels`);
                const channels = await res.json();
                const tbody = document.getElementById('channel-tbody');
                if (channels.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="color:#8f98a0; text-align:center;">No notification channels configured.</td></tr>';
                    return;
                }
                tbody.innerHTML = channels.map(c => `
                    <tr>
                        <td>${escapeHtml(c.name)}</td>
                        <td>${escapeHtml(c.channel_type)}</td>
                        <td>
                            <button class="toggle-btn ${c.enabled ? 'active' : ''}"
                                onclick="toggleChannel(${c.id}, ${c.enabled ? 0 : 1})">
                                ${c.enabled ? 'ON' : 'OFF'}
                            </button>
                        </td>
                        <td>
                            <button class="toggle-btn" onclick="testChannel(${c.id})">Test</button>
                            <button class="toggle-btn" onclick="deleteChannel(${c.id})">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Failed to load channels:', err);
            }
        }

        function showAddChannelForm() {
            document.getElementById('add-channel-form').style.display = 'block';
        }

        function hideAddChannelForm() {
            document.getElementById('add-channel-form').style.display = 'none';
        }

        async function addChannel() {
            const name = document.getElementById('channel-name').value.trim();
            const type = document.getElementById('channel-type').value;
            const url = document.getElementById('channel-url').value.trim();

            if (!name || !url) {
                alert('Name and URL are required');
                return;
            }

            try {
                await fetchWithAuth(`${API}/api/alerts/channels`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, channel_type: type, config: { url } })
                });
                document.getElementById('channel-name').value = '';
                document.getElementById('channel-url').value = '';
                hideAddChannelForm();
                loadChannels();
            } catch (err) {
                console.error('Failed to add channel:', err);
            }
        }

        async function toggleChannel(id, enabled) {
            try {
                await fetchWithAuth(`${API}/api/alerts/channels/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                loadChannels();
            } catch (err) {
                console.error('Failed to toggle channel:', err);
            }
        }

        async function testChannel(id) {
            try {
                const res = await fetchWithAuth(`${API}/api/alerts/channels/${id}/test`, { method: 'POST' });
                const data = await res.json();
                alert(data.success ? 'Test notification sent!' : 'Test failed: ' + (data.error || 'Unknown error'));
            } catch (err) {
                alert('Test failed: ' + err.message);
            }
        }

        async function deleteChannel(id) {
            if (!confirm('Delete this notification channel?')) return;
            try {
                await fetchWithAuth(`${API}/api/alerts/channels/${id}`, { method: 'DELETE' });
                loadChannels();
            } catch (err) {
                console.error('Failed to delete channel:', err);
            }
        }

        // ---- File Browser ----
        let currentBrowsePath = '';

        function browseFiles() {
            if (!currentDeviceId || !socket) return;
            const pathInput = document.getElementById('file-browse-path');
            const path = pathInput.value.trim();
            if (!path) { alert('Enter a path to browse'); return; }
            currentBrowsePath = path;
            document.getElementById('file-browser-area').innerHTML = '<div style="font-size:13px; color:#8f98a0;">Requesting access...</div>';
            socket.emit('request_file_browse', { deviceId: currentDeviceId, path });
        }

        function renderFileBrowser(data) {
            const area = document.getElementById('file-browser-area');
            if (!data.approved) {
                area.innerHTML = `<div style="color:#ef5350; font-size:13px;">Access denied by user</div>`;
                return;
            }
            if (data.error) {
                area.innerHTML = `<div style="color:#ef5350; font-size:13px;">${escapeHtml(data.error)}</div>`;
                return;
            }

            const entries = data.entries || [];
            // Build breadcrumb
            const parts = data.path.replace(/\\/g, '/').split('/').filter(Boolean);
            let breadcrumb = '<div class="file-breadcrumb">';
            let accumulated = '';
            for (let i = 0; i < parts.length; i++) {
                accumulated += parts[i] + '/';
                const p = accumulated;
                breadcrumb += `<span onclick="navigateToPath('${escapeHtml(p.replace(/'/g, "\\'"))}')">${escapeHtml(parts[i])}</span>/`;
            }
            breadcrumb += '</div>';

            let html = `<div class="file-browser">${breadcrumb}<ul class="file-list">`;
            if (entries.length === 0) {
                html += '<li style="color:#8f98a0;">Directory is empty</li>';
            }
            for (const entry of entries) {
                const icon = entry.Type === 'dir' ? '\uD83D\uDCC1' : '\uD83D\uDCC4';
                const size = entry.Type === 'file' ? formatFileSize(entry.SizeBytes) : '';
                const fullPath = data.path.replace(/\\/g, '/').replace(/\/$/, '') + '/' + entry.Name;
                if (entry.Type === 'dir') {
                    html += `<li onclick="navigateToPath('${escapeHtml(fullPath.replace(/'/g, "\\'"))}')">
                        <span class="file-icon">${icon}</span>
                        <span class="file-name">${escapeHtml(entry.Name)}</span>
                    </li>`;
                } else {
                    html += `<li onclick="requestFileRead('${escapeHtml(fullPath.replace(/'/g, "\\'"))}')">
                        <span class="file-icon">${icon}</span>
                        <span class="file-name">${escapeHtml(entry.Name)}</span>
                        <span class="file-size">${size}</span>
                    </li>`;
                }
            }
            html += '</ul></div>';
            area.innerHTML = html;
        }

        function navigateToPath(path) {
            if (!currentDeviceId || !socket) return;
            document.getElementById('file-browse-path').value = path;
            currentBrowsePath = path;
            document.getElementById('file-browser-area').innerHTML = '<div style="font-size:13px; color:#8f98a0;">Requesting access...</div>';
            socket.emit('request_file_browse', { deviceId: currentDeviceId, path });
        }

        function requestFileRead(path) {
            if (!currentDeviceId || !socket) return;
            document.getElementById('file-browser-area').innerHTML += '<div style="font-size:13px; color:#8f98a0; margin-top:8px;">Requesting file access...</div>';
            socket.emit('request_file_read', { deviceId: currentDeviceId, path });
        }

        function renderFileContent(data) {
            const area = document.getElementById('file-browser-area');
            if (!data.approved) {
                area.innerHTML += `<div style="color:#ef5350; font-size:13px; margin-top:8px;">File read denied by user</div>`;
                return;
            }
            if (data.error) {
                area.innerHTML += `<div style="color:#ef5350; font-size:13px; margin-top:8px;">${escapeHtml(data.error)}</div>`;
                return;
            }
            const fileName = data.path.split(/[/\\]/).pop();
            const viewer = `<div class="file-viewer">
                <div class="file-header">
                    <span>${escapeHtml(fileName)} (${formatFileSize(data.sizeBytes)})</span>
                    <button class="diag-btn" onclick="copyFileContent()" style="font-size:11px; padding:3px 8px;">Copy</button>
                </div>
                <pre id="file-content-pre">${escapeHtml(data.content)}</pre>
            </div>`;
            // Append viewer below the file list
            area.innerHTML += viewer;
        }

        function copyFileContent() {
            const pre = document.getElementById('file-content-pre');
            if (pre) navigator.clipboard.writeText(pre.textContent);
        }

        function formatFileSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // ---- Remote Scripts ----
        let scriptLibraryData = [];

        async function loadScriptLibrary() {
            try {
                const res = await fetchWithAuth(`${API}/api/scripts`);
                scriptLibraryData = await res.json();
                const sel = document.getElementById('script-library-select');
                sel.innerHTML = '<option value="">-- Select from library --</option>' +
                    scriptLibraryData.map(s => `<option value="${s.id}">${escapeHtml(s.name)} (${escapeHtml(s.category)})</option>`).join('');
            } catch (err) {
                console.error('Failed to load scripts:', err);
            }
        }

        function runLibraryScript() {
            if (!currentDeviceId || !socket) return;
            const sel = document.getElementById('script-library-select');
            const scriptId = parseInt(sel.value);
            if (!scriptId) { alert('Select a script from the library'); return; }
            showScriptRunning();
            socket.emit('execute_library_script', { deviceId: currentDeviceId, scriptId });
        }

        function runAdhocScript() {
            if (!currentDeviceId || !socket) return;
            const content = document.getElementById('adhoc-script').value.trim();
            if (!content) { alert('Enter a script to execute'); return; }
            const elevation = document.getElementById('adhoc-elevation').checked;
            const timeout = parseInt(document.getElementById('adhoc-timeout').value) || 60;
            showScriptRunning();
            socket.emit('execute_script', {
                deviceId: currentDeviceId,
                scriptName: 'Ad-hoc Script',
                scriptContent: content,
                requiresElevation: elevation,
                timeoutSeconds: timeout
            });
        }

        function showScriptRunning() {
            document.getElementById('script-output-area').innerHTML = '<div style="font-size:13px; color:#8f98a0; margin-top:8px;"><span class="script-spinner"></span>Waiting for user approval and execution...</div>';
        }

        function renderScriptResult(data) {
            const area = document.getElementById('script-output-area');
            let statusBadge = data.success
                ? '<span style="color:#66bb6a;">Success</span>'
                : '<span style="color:#ef5350;">Failed</span>';
            if (data.timedOut) statusBadge = '<span style="color:#ffa726;">Timed Out</span>';
            if (data.validationError) statusBadge = '<span style="color:#ef5350;">Blocked</span>';

            let html = `<div class="script-output">
                <div class="meta">
                    Status: ${statusBadge} | Exit Code: ${data.exitCode ?? '—'} | Duration: ${data.durationMs ?? 0}ms
                    ${data.truncated ? ' | <span style="color:#ffa726;">Output truncated</span>' : ''}
                </div>`;

            if (data.validationError) {
                html += `<pre class="stderr">${escapeHtml(data.validationError)}</pre>`;
            } else {
                if (data.output) html += `<pre class="stdout">${escapeHtml(data.output)}</pre>`;
                if (data.errorOutput) html += `<pre class="stderr">${escapeHtml(data.errorOutput)}</pre>`;
                if (!data.output && !data.errorOutput) html += `<pre class="stdout">(no output)</pre>`;
            }

            html += '</div>';
            area.innerHTML = html;
        }

        // ---- Auto-Remediation Policies ----
        async function loadPolicies() {
            try {
                const res = await fetchWithAuth(`${API}/api/alerts/policies`);
                const policies = await res.json();
                const tbody = document.getElementById('policy-tbody');
                if (policies.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="color:#8f98a0; text-align:center;">No auto-remediation policies configured.</td></tr>';
                    return;
                }
                tbody.innerHTML = policies.map(p => `
                    <tr>
                        <td>${escapeHtml(p.check_type)} ${escapeHtml(p.operator)}${p.threshold_value} (${p.severity})</td>
                        <td>${escapeHtml(p.action_id)}</td>
                        <td>${p.parameter ? escapeHtml(p.parameter) : '<span style="color:#8f98a0">—</span>'}</td>
                        <td>${p.cooldown_minutes}min</td>
                        <td>${p.require_consent ? 'Yes' : '<span style="color:#ffa726">No</span>'}</td>
                        <td>
                            <button class="toggle-btn ${p.enabled ? 'active' : ''}"
                                onclick="togglePolicy(${p.id}, ${p.enabled ? 0 : 1})">
                                ${p.enabled ? 'ON' : 'OFF'}
                            </button>
                        </td>
                        <td><button class="toggle-btn" onclick="deletePolicy(${p.id})">Delete</button></td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Failed to load policies:', err);
            }
        }

        function showAddPolicyForm() {
            document.getElementById('add-policy-form').style.display = 'block';
            // Populate threshold dropdown
            fetchWithAuth(`${API}/api/alerts/thresholds`).then(r => r.json()).then(thresholds => {
                const sel = document.getElementById('policy-threshold');
                sel.innerHTML = thresholds.map(t =>
                    `<option value="${t.id}">${escapeHtml(t.check_type)} ${escapeHtml(t.operator)} ${t.threshold_value} (${t.severity})</option>`
                ).join('');
            });
        }

        function hideAddPolicyForm() {
            document.getElementById('add-policy-form').style.display = 'none';
        }

        async function addPolicy() {
            const threshold_id = parseInt(document.getElementById('policy-threshold').value);
            const action_id = document.getElementById('policy-action').value;
            const parameter = document.getElementById('policy-parameter').value.trim() || null;
            const cooldown_minutes = parseInt(document.getElementById('policy-cooldown').value) || 30;
            const require_consent = document.getElementById('policy-consent').checked ? 1 : 0;
            try {
                await fetchWithAuth(`${API}/api/alerts/policies`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ threshold_id, action_id, parameter, cooldown_minutes, require_consent })
                });
                hideAddPolicyForm();
                loadPolicies();
            } catch (err) {
                console.error('Failed to add policy:', err);
            }
        }

        async function togglePolicy(id, enabled) {
            try {
                await fetchWithAuth(`${API}/api/alerts/policies/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                loadPolicies();
            } catch (err) {
                console.error('Failed to toggle policy:', err);
            }
        }

        async function deletePolicy(id) {
            if (!confirm('Delete this policy?')) return;
            try {
                await fetchWithAuth(`${API}/api/alerts/policies/${id}`, { method: 'DELETE' });
                loadPolicies();
            } catch (err) {
                console.error('Failed to delete policy:', err);
            }
        }

        // ---- Init ----
        async function init() {
            try {
                // Auto-login on localhost — skip the login screen
                if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                    const autoRes = await fetch(`${API}/api/admin/auto-login`, { method: 'POST' });
                    if (autoRes.ok) {
                        const data = await autoRes.json();
                        authToken = data.token;
                        sessionStorage.setItem('pocket_it_token', authToken);
                        hideLogin();
                        initSocket();
                        setupDesktopInput();
                        loadFleet();
                        return;
                    }
                }
                // Normal auth check (remote or auto-login failed)
                const res = await fetchWithAuth(`${API}/api/admin/stats`);
                if (res.ok) {
                    hideLogin();
                    initSocket();
                    setupDesktopInput();
                    loadFleet();
                } else {
                    showLogin();
                }
            } catch (err) {
                showLogin();
            }
        }
        init();

        // ========== REPORTS ==========
        let reportDays = 7;
        let chartInstances = {};

        function destroyChart(id) {
          if (chartInstances[id]) {
            chartInstances[id].destroy();
            delete chartInstances[id];
          }
        }

        const chartDefaults = {
          responsive: true,
          plugins: {
            legend: { labels: { color: '#c7d5e0' } }
          },
          scales: {
            x: { ticks: { color: '#8f98a0' }, grid: { color: 'rgba(102,192,244,0.1)' } },
            y: { ticks: { color: '#8f98a0' }, grid: { color: 'rgba(102,192,244,0.1)' } }
          }
        };

        document.querySelectorAll('.report-range-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.report-range-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            reportDays = parseInt(btn.dataset.days);
            loadReports();
          });
        });

        async function loadReports() {
          await Promise.all([
            loadFleetHealthChart(),
            loadAlertSummaryReport(),
            loadTicketSummaryReport(),
            loadDeviceList(),
            loadSchedules(),
            loadReportHistory()
          ]);
        }

        async function loadFleetHealthChart() {
          try {
            const res = await fetchWithAuth(`${API}/api/reports/fleet/health-trend?days=${reportDays}`);
            const data = await res.json();
            destroyChart('fleet-health');
            const ctx = document.getElementById('chart-fleet-health').getContext('2d');
            chartInstances['fleet-health'] = new Chart(ctx, {
              type: 'line',
              data: {
                labels: data.map(d => d.day),
                datasets: [{
                  label: 'Avg Health Score',
                  data: data.map(d => Math.round(d.avg_score * 10) / 10),
                  borderColor: '#66c0f4',
                  backgroundColor: 'rgba(102,192,244,0.1)',
                  fill: true,
                  tension: 0.3
                }]
              },
              options: {
                ...chartDefaults,
                scales: {
                  ...chartDefaults.scales,
                  y: { ...chartDefaults.scales.y, min: 0, max: 100, title: { display: true, text: 'Health Score', color: '#8f98a0' } }
                }
              }
            });
          } catch (err) { console.error('Fleet health chart error:', err); }
        }

        async function loadAlertSummaryReport() {
          try {
            const res = await fetchWithAuth(`${API}/api/reports/alerts/summary?days=${reportDays}`);
            const data = await res.json();

            document.getElementById('stat-alert-total').textContent = data.total || 0;
            document.getElementById('stat-alert-active').textContent = data.active || 0;
            document.getElementById('stat-alert-resolved').textContent = data.resolved || 0;
            document.getElementById('stat-alert-mttr').textContent = data.mttr_hours != null ? data.mttr_hours : '-';

            // Alerts per day chart
            destroyChart('alerts-per-day');
            const ctx1 = document.getElementById('chart-alerts-per-day').getContext('2d');
            chartInstances['alerts-per-day'] = new Chart(ctx1, {
              type: 'bar',
              data: {
                labels: (data.per_day || []).map(d => d.day),
                datasets: [{
                  label: 'Alerts',
                  data: (data.per_day || []).map(d => d.count),
                  backgroundColor: '#ef5350'
                }]
              },
              options: { ...chartDefaults, plugins: { ...chartDefaults.plugins, title: { display: true, text: 'Alerts Per Day', color: '#c7d5e0' } } }
            });

            // Alerts by severity chart
            destroyChart('alerts-by-severity');
            const ctx2 = document.getElementById('chart-alerts-by-severity').getContext('2d');
            const severityColors = { critical: '#d50000', warning: '#ffa726', info: '#66c0f4' };
            chartInstances['alerts-by-severity'] = new Chart(ctx2, {
              type: 'doughnut',
              data: {
                labels: (data.by_severity || []).map(d => d.severity),
                datasets: [{
                  data: (data.by_severity || []).map(d => d.count),
                  backgroundColor: (data.by_severity || []).map(d => severityColors[d.severity] || '#8f98a0')
                }]
              },
              options: { responsive: true, plugins: { legend: { labels: { color: '#c7d5e0' } }, title: { display: true, text: 'By Severity', color: '#c7d5e0' } } }
            });
          } catch (err) { console.error('Alert summary error:', err); }
        }

        async function loadTicketSummaryReport() {
          try {
            const res = await fetchWithAuth(`${API}/api/reports/tickets/summary?days=${reportDays}`);
            const data = await res.json();

            document.getElementById('stat-ticket-total').textContent = data.total || 0;
            document.getElementById('stat-ticket-open').textContent = data.open || 0;
            document.getElementById('stat-ticket-resolved').textContent = data.resolved || 0;
            document.getElementById('stat-ticket-avgres').textContent = data.avg_resolution_hours != null ? data.avg_resolution_hours : '-';

            destroyChart('tickets-per-day');
            const ctx = document.getElementById('chart-tickets-per-day').getContext('2d');
            chartInstances['tickets-per-day'] = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: (data.per_day || []).map(d => d.day),
                datasets: [
                  { label: 'Opened', data: (data.per_day || []).map(d => d.opened), backgroundColor: '#ffa726' },
                  { label: 'Closed', data: (data.per_day || []).map(d => d.closed), backgroundColor: '#66bb6a' }
                ]
              },
              options: { ...chartDefaults, plugins: { ...chartDefaults.plugins, title: { display: true, text: 'Tickets Per Day', color: '#c7d5e0' } } }
            });
          } catch (err) { console.error('Ticket summary error:', err); }
        }

        async function loadDeviceList() {
          try {
            const res = await fetchWithAuth(`${API}/api/devices`);
            const devices = await res.json();
            const select = document.getElementById('report-device-select');
            const currentVal = select.value;
            select.innerHTML = '<option value="">Select a device...</option>' +
              devices.map(d => `<option value="${d.device_id}">${d.hostname || d.device_id}</option>`).join('');
            if (currentVal) select.value = currentVal;
          } catch (err) { console.error('Load devices for reports error:', err); }
        }

        async function loadDeviceMetrics() {
          const deviceId = document.getElementById('report-device-select').value;
          const checkType = document.getElementById('report-metric-select').value;
          const emptyEl = document.getElementById('device-metrics-empty');

          if (!deviceId) {
            emptyEl.style.display = 'block';
            return;
          }
          emptyEl.style.display = 'none';

          try {
            const res = await fetchWithAuth(`${API}/api/reports/device/${deviceId}/metrics?check_type=${checkType}&days=${reportDays}`);
            const data = await res.json();

            destroyChart('device-metrics');
            const ctx = document.getElementById('chart-device-metrics').getContext('2d');
            chartInstances['device-metrics'] = new Chart(ctx, {
              type: 'line',
              data: {
                labels: data.map(d => d.period),
                datasets: [
                  { label: 'Average', data: data.map(d => d.avg_value), borderColor: '#66c0f4', tension: 0.3 },
                  { label: 'Max', data: data.map(d => d.max_value), borderColor: '#ef5350', borderDash: [5, 5], tension: 0.3 },
                  { label: 'Min', data: data.map(d => d.min_value), borderColor: '#66bb6a', borderDash: [5, 5], tension: 0.3 }
                ]
              },
              options: {
                ...chartDefaults,
                scales: {
                  ...chartDefaults.scales,
                  y: { ...chartDefaults.scales.y, min: 0, max: 100, title: { display: true, text: checkType.toUpperCase() + ' %', color: '#8f98a0' } }
                }
              }
            });
          } catch (err) { console.error('Device metrics error:', err); }
        }

        function exportReport(format) {
          // Use current view's report type — default to fleet_health
          const url = `${API}/api/reports/export?type=fleet_health&days=${reportDays}&format=${format}`;
          window.open(url, '_blank');
        }

        async function loadSchedules() {
          try {
            const res = await fetchWithAuth(`${API}/api/reports/schedules`);
            const schedules = await res.json();
            const container = document.getElementById('schedules-list');
            if (!schedules.length) {
              container.innerHTML = '<div class="empty-state">No scheduled reports</div>';
              return;
            }
            container.innerHTML = schedules.map(s => `
              <div style="background:#1b2838; border:1px solid #2a475e; border-radius:8px; padding:14px 20px; margin-bottom:8px; display:flex; align-items:center; gap:16px;">
                <div style="flex:1;">
                  <div style="color:#c7d5e0; font-weight:600;">${s.name}</div>
                  <div style="color:#8f98a0; font-size:12px;">${s.report_type} &middot; ${s.schedule} &middot; ${s.format.toUpperCase()}</div>
                </div>
                <span style="color:${s.enabled ? '#66bb6a' : '#8f98a0'}; font-size:12px;">${s.enabled ? 'Active' : 'Disabled'}</span>
                <button class="diag-btn" onclick="toggleSchedule(${s.id}, ${s.enabled ? 0 : 1})" style="font-size:12px;">${s.enabled ? 'Disable' : 'Enable'}</button>
                <button class="diag-btn" onclick="deleteSchedule(${s.id})" style="font-size:12px; color:#ef5350;">Delete</button>
              </div>
            `).join('');
          } catch (err) { console.error('Load schedules error:', err); }
        }

        function showScheduleForm() { document.getElementById('schedule-form').style.display = 'block'; }
        function hideScheduleForm() { document.getElementById('schedule-form').style.display = 'none'; }

        async function saveSchedule() {
          try {
            const body = {
              name: document.getElementById('sched-name').value,
              report_type: document.getElementById('sched-type').value,
              schedule: document.getElementById('sched-cron').value,
              format: document.getElementById('sched-format').value,
              filters: { days: reportDays }
            };
            if (!body.name || !body.schedule) return alert('Name and cron schedule are required');
            await fetchWithAuth(`${API}/api/reports/schedules`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
            });
            hideScheduleForm();
            loadSchedules();
          } catch (err) { console.error('Save schedule error:', err); }
        }

        async function toggleSchedule(id, enabled) {
          try {
            await fetchWithAuth(`${API}/api/reports/schedules/${id}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ enabled })
            });
            loadSchedules();
          } catch (err) { console.error('Toggle schedule error:', err); }
        }

        async function deleteSchedule(id) {
          if (!confirm('Delete this scheduled report?')) return;
          try {
            await fetchWithAuth(`${API}/api/reports/schedules/${id}`, { method: 'DELETE' });
            loadSchedules();
          } catch (err) { console.error('Delete schedule error:', err); }
        }

        async function loadReportHistory() {
          try {
            const res = await fetchWithAuth(`${API}/api/reports/history?limit=20`);
            const history = await res.json();
            const container = document.getElementById('report-history-list');
            if (!history.length) {
              container.innerHTML = '<div class="empty-state">No reports generated yet</div>';
              return;
            }
            container.innerHTML = history.map(h => `
              <div style="background:#1b2838; border:1px solid #2a475e; border-radius:8px; padding:12px 20px; margin-bottom:6px; display:flex; align-items:center; gap:16px;">
                <div style="flex:1;">
                  <span style="color:#c7d5e0;">${h.schedule_name || 'On-demand'}</span>
                  <span style="color:#8f98a0; font-size:12px; margin-left:8px;">${h.report_type} &middot; ${h.format.toUpperCase()}</span>
                </div>
                <span style="color:#8f98a0; font-size:12px;">${new Date(h.created_at).toLocaleString()}</span>
              </div>
            `).join('');
          } catch (err) { console.error('Load history error:', err); }
        }
    </script>
</body>
</html>
